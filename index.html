<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Budget Months</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #e3f2fd; font-family: 'Segoe UI', Arial, sans-serif; }
        .month-grid { display: flex; flex-wrap: wrap; gap: 24px; padding: 40px; }
        .month-box {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
            width: 220px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: #1976d2;
            cursor: pointer;
            transition: box-shadow 0.2s;
            position: relative;
        }
        .month-box:hover { box-shadow: 0 4px 16px rgba(44,62,80,0.15); background: #e0f7fa; }
        .add-btn {
            margin: 40px;
            padding: 16px 32px;
            font-size: 1.2em;
            border-radius: 12px;
        }
        .delete-month-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            color: #1976d2;
            background: transparent;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 10;
        }
        .delete-month-btn:hover { color: darkred; }
    </style>
</head>
<body>
    <h1 class="text-center mt-4 mb-2">Budget Months</h1>
    <div class="month-grid" id="monthGrid"></div>
    <div class="text-center">
        <button class="btn btn-success add-btn" onclick="addNewMonth()">Add New Month</button>
    </div>
    <script>
        function getMonthName(ym) {
            const [year, month] = ym.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function getCurrentMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        async function fetchMonths() {
            const res = await fetch("/months");
            if (!res.ok) {
                console.error("Failed to fetch months:", res.status);
                return [];
            }
            return await res.json(); // [{id:1, ym:"2025-08"}]
        }

        async function renderMonths() {
            const grid = document.getElementById('monthGrid');
            grid.innerHTML = '';
            const months = await fetchMonths();

            months.sort((a, b) => a.ym.localeCompare(b.ym)).forEach(m => {
                const ym = m.ym;
                const box = document.createElement('div');
                box.className = 'month-box';
                box.innerText = getMonthName(ym);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-month-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete ${getMonthName(ym)}?`)) {
                        await fetch("/delete_month", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({ ym })
                        });
                        renderMonths();
                    }
                };
                box.appendChild(deleteBtn);

                box.onclick = () => {
                    localStorage.setItem('activeMonth', ym); // temporary nav state only
                    window.location.href = 'bud.html';
                };

                grid.appendChild(box);
            });
        }

        async function addNewMonth() {
            const months = await fetchMonths();
            let nextYm;

            if (months.length === 0) {
                nextYm = getCurrentMonth();
            } else {
                const last = months[months.length - 1].ym;
                const [year, month] = last.split('-').map(Number);
                let nextYear = year, nextMonth = month + 1;
                if (nextMonth > 12) { nextMonth = 1; nextYear++; }
                nextYm = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
            }

            await fetch("/add_month", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ ym: nextYm })
            });

            renderMonths();
        }

        renderMonths();
    </script>
</body>
</html>
